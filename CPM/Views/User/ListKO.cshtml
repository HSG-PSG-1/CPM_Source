@model PagedList<CPM.DAL.vw_Users_Role_Org>
@using System.Collections
@using Webdiyer.WebControls.Mvc
@using CPM.Services
@using CPM.Helper
@{ ViewBag.Title = "User List KO"; Layout = Defaults.masterLayout;}
@section HeadContent {
    @*SOME scripts are better persisted in head *@ @*<script src="@Url.Content("~/Content/Scripts/KO/jquery-1.7.2.min.js")" type="text/javascript"></script>*@
    <script src="@Url.Content("~/Content/Scripts/KO/knockout-2.2.0.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Content/Scripts/KO/knockout.mapping-latest.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Content/Scripts/KO/KoGrid.debug.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Content/Scripts/KO/KoExtra.js")" type="text/javascript"></script>

    <link href="@Url.Content("~/Content/Scripts/KO/KoGrid.css")" rel="stylesheet" type="text/css" />

    <style>
    .gridStyle {
    border: 1px solid rgb(212,212,212);
    width: 90%; 
    height: 600px
    }
    </style>
    
    @*<script src="@Url.Content("~/Content/Scripts/KO/jquery.tmpl.js")" type="text/javascript"></script>*@
}
@{ CPM.DAL.vw_Users_Role_Org usrSearch = ((CPM.DAL.vw_Users_Role_Org)(ViewData["SearchData"]));
    object routeValues = new { qData = Request["qData"] };
    Dictionary<string, object> txtAttr = new Dictionary<string, object>();
    txtAttr.Add("class", "hdrTxt textBox");
    txtAttr.Add("onchange", "setFiltered(1,this);");
    bool? oprSuccess = ((bool?)ViewData["oprSuccess"]);
}
<table width="100%" border="0">
    <tr>
        <td class="sqz" valign="top">
            <b class="smallHeading">Manage User</b>
        </td>
        <td align="center" style="width: 98%">
            &nbsp;
        </td>
        <td class="sqz" align="right" valign="top">
            @Html.ActionLink("Create New", "AddEdit", new { id = Defaults.Integer })&nbsp;
        </td>
    </tr>
    <tr>
        <td colspan="3">                
            <fieldset style="display:none">
                <legend onclick="showHideDiv('tblSearch')" style="cursor: pointer">&nbsp;<img id="tblSearchImg"
                    src="@Url.Content("~/Content/Images/aroB.gif")" alt="Show/Hide panel" />
                    &nbsp;Search&nbsp;</legend>
                <div id="tblSearch">
                <form action="@Url.Content("~/Users/ListKO")" method="post" id="frm" style="display: inline" onsubmit="return doAJAXSubmit(this);">
                <table id="tblSearch" cellpadding="2" cellspacing="2" border="0" width="100%">
                    <tr>
                        <td nowrap="nowrap" width="5%">Name</td>
                        <td>@Html.TextBox("UserName", "", txtAttr)</td>                            
                        <td nowrap="nowrap" width="5%">Email</td>
                        <td>@Html.TextBox("Email", "", txtAttr)</td>
                        <td nowrap="nowrap" width="5%">Role</td>
                        <td nowrap="nowrap">@Html.DropDownList("RoleID", new SelectList((IEnumerable)ViewData["Roles"], "ID", "TEXT"), "All Roles", new { @class = "dropDown" })</td>
                        <td nowrap="nowrap"align="right" colspan="6"><input type="submit" onclick="return doAJAXSubmit(this);" value="Search" class="button" />
                            &nbsp;<input type="submit" value="Reset" class="button" onclick="clearForm(document.getElementById('frm')); document.getElementById('doReset').checked = true;" />
                            <input type="checkbox" name="doReset" id="doReset" style="display: none;" />
                        </td>
                    </tr>
                </table>
                </form>
                <div id="tdGrid">
                    @* Try in future if needed @{Html.RenderPartial("./EditorTemplates/UserList", Model);}
                    @{ Html.RenderAction("UserList", "User"); }*@
                    <table width="100%" class="thinBorder" border="0">
    <thead class="header">
        <tr>
            <th nowrap="nowrap" width="2%"></th>
            <th nowrap="nowrap">Org Type</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>            
        </tr>
    </thead>
    <tbody data-bind="foreach: Users">
        <tr>
            <td nowrap="nowrap">
                <a data-bind="attr: { href: '@Html.Raw(Url.Action("AddEdit"))/' + ID}">@Html.Raw(Defaults.editImg)</a>
                <div class="dDialog" data-bind="click:$parent.removeSelected">@Html.Raw(@Defaults.delImg)</div>
            </td>
            <td data-bind="text:OrgType"></td>
            <td data-bind="text:UserName"></td>
            <td data-bind="text:Email"></td>
            <td data-bind="text:RoleName"></td>            
        </tr>
    </tbody>
        <tfoot>
        <tr>
            <td colspan="5">
                <table cellpadding="0" cellspacing="0" class="pager">
                    <tr>
                        <td nowrap="nowrap" width="2%">&nbsp;Record count : </td>
                        <td data-bind="text:Users().length" align="left"></td>
                        <td width="96%"></td>
                    </tr>
                </table>
            </td>
        </tr>
    </tfoot>
</table>
                </div>
                </div>
            </fieldset>
            <!-- END: Search Panel -->
        </td>
    </tr>
    <tr>
        <td colspan="3">
                @*HT: OLD table location*@
                <div class="gridStyle" data-bind="koGrid: gridOptions"></div>

        </td>
    </tr>
</table>
<script type="text/javascript" id="mailToCellTemplate">   
var mailToCellTemplate = 
'<u><a data-bind="attr:{href:\'javascript:MailTo(\' + \'\\\'\' + $parent.entity[\'Email\'] + \'\\\'\' + \')\'}, text: $parent.entity[\'Email\']"></a></u>';
@*'<div data-bind="attr:{'href'},html: $data.getProperty($parent)"></div>';
<div data-bind=" attr: { 'class': 'kgCellText colt' + $index()} }, html: $data.getProperty($parent)"></div>
<a data-bind="attr: { 'href': 'mailto:' + $data.getProperty($parent)}, html: $data.getProperty($parent)">
hmnt</a>*@
</script>
<script language="javascript" type="text/javascript" defer="defer">        setFocus("UserName");
        var ListURL = '@Url.Action("UserListKO", "User")';
    function doAJAXSubmit(frm) {
        $.ajax({
            type: "POST",
            //contentType: "application/json; charset=utf-8",
            //dataType: "json",
            data: $("#frm").serialize(),
            url: ListURL,
            success: function (data) {
                if (data != null) {
                    viewModel.Users(data); //ko.observableArray
                    document.getElementById('doReset').checked = false;
                }
            }
        });

        //event.preventDefault();
        return false;
    }    
    var userListModel = function () {
        var self = this;        
        self.Users = ko.observableArray(); // Initial items        
        self.removeSelected = function (user) {
            if (user != null) // Prevent blanks and duplicates
                self.Users.remove(user);
        };
    };
    
    var viewModel = new userListModel();
    function createKO() {
        $.getJSON(ListURL, function (data) {
            viewModel.Users = ko.observableArray(data); //ko.mapping.fromJS(data.AllComments); // Initial items                      
            viewModel.gridOptions = { data: viewModel.Users, showGroupPanel: true, jqueryUIDraggable: true, /* jqueryUITheme: true,*/
                columnDefs: [{ field: 'OrgType', displayName: 'Org Type' }, { field: 'UserName', displayName: 'Name' },
                { field: 'Email', displayName: 'Email', cellTemplate: mailToCellTemplate },
                { field: 'RoleName', displayName: 'Role' },
                { field: 'LastModifiedDate', displayName: 'LastModified',
                    cellFormatter: function (jsonDate) { return ParseJSONdate(jsonDate); }
                }]
            };

            viewModel.MailTo = function () {
                alert('data');
            }
            ko.applyBindings(viewModel);
        });
    }
    $(document).ready(function () {
        createKO();
    });
    var MailTo = function (data) { alert("Send mail to : " + data);
        //Try this while using external KO template: https://groups.google.com/forum/#!msg/knockoutjs/1WDUJNd-VQ0/SBVuJttE91UJ
     }
</script>
